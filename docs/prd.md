# 数据管理与查询系统 - 产品需求文档

## 1. 产品概述

### 1.1 产品背景

现代企业环境中，业务数据往往分散在多个数据库系统中，如MySQL、DB2等。业务用户和开发人员需要高效地访问和查询这些数据，但面临以下挑战：

1. 数据源分散且缺乏统一管理
2. 需要专业的SQL技能才能有效查询数据
3. 构建基于数据库的应用需要大量重复工作
4. 缺乏将数据查询与低代码平台集成的便捷方式

数据管理与查询系统旨在解决这些问题，为企业内部用户提供一个统一的平台，实现数据源管理、智能化查询和低代码应用快速开发。

### 1.2 产品目标

1. 提供统一的数据源管理平台，支持多种数据库系统
2. 降低数据查询门槛，支持SQL和自然语言查询
3. 加速基于数据的应用开发，与低代码平台无缝集成
4. 提高企业数据资产的可用性和价值

### 1.3 目标用户

1. **数据管理员**：负责配置和管理数据源
2. **业务分析师**：需要频繁查询和分析数据
3. **应用开发者**：构建基于数据的应用
4. **普通业务用户**：需要查询数据但缺乏SQL技能

## 2. 功能需求

### 2.1 数据源管理

#### 2.1.0 概述
数据源管理模块是系统的基础和核心，负责连接管理多种类型的数据库系统。该模块实现数据源的注册、管理、连接测试和元数据同步，为系统的其他功能模块提供数据服务支持。

#### 2.1.1 数据源配置
- 支持MySQL和DB2数据库系统的注册和配置
- 数据源模型应包含必要的连接信息：类型、名称、描述、主机、端口、数据库名、用户名、密码、连接参数等
- 提供数据源连接测试功能
- 支持数据源连接参数的编辑和更新
- 数据源凭证采用加盐AES加密存储
- 支持数据源的启用/禁用状态管理
- 记录创建时间、更新时间和最后同步时间

#### 2.1.2 元数据管理
- 自动提取数据源的完整元数据：
  - 模式（Schema）信息
  - 表信息（包括视图）
  - 列信息（包括数据类型、是否主键、是否可为空等）
  - 索引信息
  - 外键关系信息
  - 表和列的注释
- 提供元数据版本管理功能
- 支持元数据同步功能，更新变更的数据库结构
- 提供元数据搜索和浏览功能
- 记录数据字典信息（表和列的描述等）
- 存储表大小、行数等统计信息
- 建立表之间的关系映射

#### 2.1.3 增量同步算法
- 实现智能的元数据变更检测
- 处理新增的模式、表、列
- 处理修改的表结构和列属性
- 处理删除的对象（需用户确认）
- 提供同步进度实时反馈
- 支持同步失败时的重试机制（最多3次）
- 记录同步操作日志

#### 2.1.4 数据源适配器

##### 2.1.4.1 通用接口
- 定义统一的数据源适配器接口
- 提供元数据提取方法
- 提供查询执行方法
- 提供连接管理方法

##### 2.1.4.2 特定数据库实现
- MySQL适配器实现
  - 完善isAutoIncrement方法
  - 优化表大小信息获取
- DB2适配器实现
  - 改进元数据提取性能
  - 完善错误处理机制

#### 2.1.5 数据源管理界面
- 数据源列表显示
- 数据源添加/编辑表单
- 连接测试按钮
- 元数据同步按钮
- 数据源启用/禁用开关

#### 2.1.6 元数据同步界面
- 同步进度显示
- 变更项目预览
- 确认删除项目选项
- 同步日志显示
- 重试选项


### 2.2 智能数据发现和查询

#### 2.2.1 数据结构浏览
- 树形结构展示数据源、模式、表、列层次
- 提供搜索功能快速定位表或字段
- 显示表的关键信息（记录数、数据类型等）
- 支持查看表的详细结构（列、索引、约束等）

#### 2.2.2 SQL查询构建
- 可视化查询构建界面
- 拖放式表和字段选择
- 支持WHERE条件、JOIN、GROUP BY、ORDER BY等SQL功能
- 实时显示生成的SQL语句
- 查询验证和错误提示

#### 2.2.3 自然语言查询
- 支持中文自然语言描述数据需求
- 集成OpenRouter LLM API将自然语言转换为SQL
- 显示生成的SQL并支持编辑
- 优化建议改进自然语言表述
- 学习机制提高转换准确性

#### 2.2.4 表关系管理
- 自动识别数据库定义的外键关系
- 基于列名和数据分析推断潜在表关系
- 为推断的关系提供置信度评分
- 支持手动确认、编辑或删除关系
- 持久化保存表关系信息以便后续使用
- 支持导出和导入表关系定义

#### 2.2.5 查询管理
- 保存和管理查询定义
- 查询历史记录和收藏功能
- 支持查询复制和修改
- 查询分类和标签管理
- 查询执行性能统计

### 2.3 低代码集成和快速应用开发

#### 2.3.1 查询结果配置
- 配置结果列的显示属性（标题、宽度、格式等）
- 支持排序、过滤、分组规则定义
- 选择不同数据呈现形式（表格、卡片、图表等）
- 配置敏感数据列的掩码规则
- 配置操作列和行级操作按钮
- 保存用户显示偏好以用于智能推荐

#### 2.3.2 查询条件表单
- 可视化界面定义表单字段
- 支持多种输入控件类型
- 设置字段验证规则和默认值
- 自定义表单布局
- 标记必填查询条件
- 自动隐藏不常用条件
- 根据数据类型自动推荐UI组件

#### 2.3.3 AI辅助配置
- 基于查询结构推荐展示形式
- 智能表单布局建议
- 数据特性驱动的图表类型建议
- 可应用或自定义的配置模板
- 基于用户历史偏好的个性化推荐

#### 2.3.4 低代码平台集成
- JSON交互协议定义
- 配置导出为低代码平台可用格式
- 提供API用于低代码平台调用
- 版本控制确保向后兼容性
- 集成示例和文档

### 2.4 API和服务集成

#### 2.4.1 REST API
- 将查询发布为REST API
- 支持参数化API设计
- API版本控制和变更管理
- API使用统计和监控
- API参数可多于界面显示的条件和结果列
- 查询超时限制（默认30秒）
- API访问频率限制

#### 2.4.2 数据导出
- 导出查询结果为CSV格式
- 导出文件命名包含查询名称和时间戳
- 配置导出列和顺序
- 大数据集分页导出
- 单次导出限制（最多50000条）
- 应用与界面相同的数据掩码规则
- 后台处理大型导出任务

### 2.5 安全和性能

#### 2.5.1 安全管理
- 数据源凭证加密存储
- 凭证变更审计日志
- 敏感数据掩码处理
- SQL注入防护
- API密钥管理

#### 2.5.2 性能优化
- 查询执行时间和资源使用监控
- 长时间运行查询识别
- 查询优化建议（索引、重写等）
- 性能阈值和告警
- 历史性能趋势分析

#### 2.5.3 资源管理
- 用户查询频率限制
- 超过限制时的友好提示
- 优先级机制处理紧急查询
- 数据下载量限制（最大50000条）
- 大型查询异步处理模式

### 2.6 用户界面

#### 2.6.1 界面设计
- 使用HTML和Tailwind CSS实现
- 响应式设计适应不同设备
- 集成FontAwesome图标
- 使用真实UI图片
- 模块化页面设计

#### 2.6.2 数据可视化
- 多种图表类型（柱状图、饼图、折线图等）
- 交互式仪表板
- 自定义图表属性
- 导出可视化结果
- 动态更新图表数据

## 3. 非功能需求

### 3.1 技术需求

- **开发语言**：Java 17+
- **框架**：Spring Boot 3.x, MyBatis 3.x
- **构建工具**：Maven
- **后端数据库**：MySQL (系统数据存储)
- **缓存系统**：Redis
- **前端技术**：HTML5, Tailwind CSS, JavaScript/TypeScript, Vue.js 3
- **外部API**：OpenRouter LLM API

### 3.2 性能需求

- 系统应支持不超过100个数据源
- 每个数据源不超过100个表（元数据同步操作应该支持大型数据库，数千张表）
- 数据库连接应使用连接池机制优化性能
- 元数据查询操作应有合理的缓存机制
- 重试机制处理暂时性连接失败
- 表数据量从几千到几亿不等
- 页面加载时间应在3秒内
- 简单查询应在5秒内返回结果
- 复杂查询应有进度指示器
- 系统应能处理同时10-20个用户查询

### 3.3 安全需求

- 数据源凭证必须加密存储
- 连接信息应进行安全传输
- 敏感数据库操作应有审计日志
- 敏感数据必须支持掩码处理
- 查询必须防止SQL注入
- API必须支持认证和访问控制
- 系统操作须有审计日志

### 3.4 可用性要求

- 系统在本地部署环境应达到99%可用性
- 系统应有明确的错误信息和故障恢复机制
- 界面应遵循直观、易用的设计原则
- 元数据同步支持部分成功处理
- 主要功能应有用户帮助文档

### 3.5 可维护性要求

- 模块化设计便于功能扩展
- 完整的开发文档和注释
- 一致的代码风格和命名规范
- 全面的单元测试和集成测试
- 支持配置外部化

### 3.6 可扩展性要求

- 支持未来添加新的数据源类型
- 模块化架构便于扩展新功能
- 支持扩展数据呈现形式
- 数据类型与UI组件映射应可配置
- 支持插件扩展机制
- 预留API接口供未来功能集成

## 4. 集成点

### 4.1 与其他模块的集成
- 向查询构建模块提供元数据信息
- 向查询执行引擎提供数据源连接服务
- 向AI助手模块提供数据结构信息
- 向安全模块提供数据源操作的审计信息

### 4.2 外部系统集成
- 与企业目录服务集成（可选）
- 支持通过API进行数据源管理
- 与指定低代码平台集成

## 5. 约束和限制

- 系统采用本地部署模式
- 访问控制由外部系统提供，本系统不需实现
- 初期支持MySQL和DB2数据源
- 系统数据存储使用MySQL

## 6. 术语和定义

| 术语 | 定义 |
|------|------|
| 数据源 | 外部数据库系统，如MySQL或DB2 |
| 元数据 | 描述数据库结构的数据，如表、列、索引等 |
| NL2SQL | 自然语言到SQL的转换 |
| 低代码平台 | 允许通过配置快速开发应用的平台 |
| API | 应用程序接口，用于系统间集成 |
| JSON协议 | 与低代码平台交互的数据格式标准 |
| 数据掩码 | 隐藏敏感数据的技术，如显示"****"代替实际数据 |

## 7. 假设和依赖

### 7.1 假设

- 用户可以访问OpenRouter LLM API
- 数据源允许元数据查询和读取
- 低代码平台支持JSON协议集成
- 目标用户熟悉基本的数据概念和操作

### 7.2 依赖

- MySQL和DB2的JDBC驱动
- Redis服务可用
- OpenRouter API服务可用