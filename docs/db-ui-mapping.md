# 数据库数据类型与UI组件映射框架

本文档定义了数据库列数据类型与前端UI组件之间的映射关系，用于自动化界面生成过程。

## 1. 映射框架概述

映射框架的目标是根据数据库列的数据类型，自动推荐最合适的前端UI组件，同时考虑数据验证规则和用户体验。这种映射应用于两个主要场景：

1. **查询条件表单生成**：根据查询参数的数据类型，生成合适的输入控件
2. **查询结果展示**：根据结果列的数据类型，选择合适的展示方式和格式化规则

## 2. 数据类型映射表

下表定义了MySQL和DB2常见数据类型到Java类型和UI组件的映射关系：

| 数据库类型 | Java类型 | 查询条件UI组件 | 结果展示组件 | 验证规则 | 格式化规则 |
|-----------|---------|--------------|------------|---------|-----------|
| **字符串类型** |
| VARCHAR, CHAR | String | 文本框 | 文本单元格 | maxLength | 无特殊格式 |
| TEXT, CLOB | String | 文本域 | 文本单元格(可展开) | - | 截断长文本 |
| ENUM | String | 下拉选择框 | 文本单元格 | enumValues | 无特殊格式 |
| **数值类型** |
| INT, SMALLINT | Integer | 数字输入框 | 数字单元格 | min, max | 千分位分隔 |
| BIGINT | Long | 数字输入框 | 数字单元格 | min, max | 千分位分隔 |
| DECIMAL, NUMERIC | BigDecimal | 数字输入框 | 数字单元格 | min, max, precision | 千分位分隔+小数位 |
| FLOAT, DOUBLE | Double | 数字输入框 | 数字单元格 | min, max | 科学计数法 |
| **日期时间类型** |
| DATE | LocalDate | 日期选择器 | 日期单元格 | minDate, maxDate | yyyy-MM-dd |
| TIME | LocalTime | 时间选择器 | 时间单元格 | - | HH:mm:ss |
| TIMESTAMP, DATETIME | LocalDateTime | 日期时间选择器 | 日期时间单元格 | - | yyyy-MM-dd HH:mm:ss |
| **布尔类型** |
| BOOLEAN, BIT(1) | Boolean | 开关/复选框 | 图标/文本 | - | ✓/✗ 或 是/否 |
| **二进制类型** |
| BLOB, BINARY | byte[] | 文件上传 | 下载链接 | maxSize, fileTypes | 文件大小 |
| **其他类型** |
| JSON | String | JSON编辑器 | 格式化JSON | validJSON | 语法高亮 |
| XML | String | XML编辑器 | 格式化XML | validXML | 语法高亮 |
| ARRAY | List<?> | 多选框/标签输入 | 标签列表 | - | 逗号分隔 |

## 3. 特殊数据类型处理

### 3.1 敏感数据类型

对于敏感数据类型，系统提供特殊的处理机制：

| 数据类型模式 | 识别规则 | UI组件 | 掩码规则 |
|------------|---------|--------|---------|
| 手机号码 | 列名包含"phone"/"mobile"/"tel" | 电话输入框 | 显示前3后4位，中间用*替代 |
| 身份证号 | 列名包含"id_card"/"idcard"/"identity" | 身份证输入框 | 显示前3后4位，中间用*替代 |
| 邮箱地址 | 列名包含"email"/"mail" | 邮箱输入框 | 显示@前首字符和@后完整域名 |
| 密码/凭证 | 列名包含"password"/"pwd"/"secret"/"key" | 密码输入框 | 完全隐藏为***** |
| 银行卡号 | 列名包含"card"/"account"/"bank" | 银行卡输入框 | 仅显示后4位 |
| 地址信息 | 列名包含"address"/"addr" | 地址输入框 | 显示省市，详细地址用***替代 |

### 3.2 特殊格式数据

对于具有特定格式的数据，系统提供专门的UI组件：

| 数据格式 | 识别规则 | UI组件 | 特殊处理 |
|---------|---------|--------|---------|
| URL | 列名包含"url"/"link"/"website" | URL输入框 | 自动验证URL格式，结果显示为可点击链接 |
| IP地址 | 列名包含"ip"/"ipaddr" | IP地址输入框 | 自动验证IP格式 |
| 颜色值 | 列名包含"color"/"colour" | 颜色选择器 | 显示颜色预览 |
| 百分比 | 列名包含"percent"/"ratio"/"rate" | 百分比输入框 | 自动转换为百分比格式 |
| 货币金额 | 列名包含"price"/"amount"/"cost"/"salary" | 金额输入框 | 自动添加货币符号和千分位 |

## 4. 查询条件组件映射

### 4.1 基础映射规则

查询条件表单生成时，除了基本的数据类型映射外，还考虑以下因素：

1. **精确匹配 vs 范围查询**：
   - 数值类型：提供精确值输入框或范围选择器
   - 日期类型：提供单日期选择或日期范围选择
   - 字符串类型：提供精确匹配、模糊匹配、前缀匹配等选项

2. **多值选择**：
   - 枚举类型：提供多选下拉框
   - 外键关联字段：提供带搜索的下拉选择器

3. **复杂条件**：
   - 提供AND/OR逻辑组合器
   - 支持嵌套条件组

### 4.2 高级查询组件

对于复杂查询场景，提供以下高级组件：

| 查询类型 | 适用数据类型 | UI组件 | 说明 |
|---------|------------|--------|------|
| 范围查询 | 数值、日期时间 | 范围选择器 | 设置最小值和最大值 |
| 多值查询 | 任意类型 | 多值选择器 | 选择多个离散值 |
| 模糊查询 | 字符串 | 带选项的文本框 | 包含、开始于、结束于等选项 |
| 空值查询 | 任意类型 | 三态选择器 | 是、否、不限（包括空值和非空值） |
| 地理位置查询 | 坐标类型 | 地图选择器 | 在地图上选择点或区域 |
| 时间段查询 | 日期时间 | 预定义时间段 | 今天、本周、本月、自定义等 |

## 5. 结果展示组件映射

### 5.1 基础展示组件

查询结果展示时，根据数据类型选择合适的展示组件：

| 数据类型 | 基础展示组件 | 高级展示组件 | 适用场景 |
|---------|------------|------------|---------|
| 文本型 | 文本单元格 | 可复制文本、富文本 | 一般文本信息 |
| 数值型 | 数字单元格 | 进度条、仪表盘 | 数量、比率等 |
| 日期时间型 | 格式化日期单元格 | 日历视图、时间轴 | 时间相关信息 |
| 布尔型 | 图标/文本 | 开关、标记 | 状态、标志等 |
| 图片URL | 缩略图 | 图片预览 | 产品图片等 |
| 文件路径 | 文件链接 | 文件预览 | 文档、附件等 |

### 5.2 特殊展示效果

根据数据特性，提供特殊的展示效果：

| 数据特性 | 展示效果 | 适用场景 |
|---------|---------|---------|
| 状态值 | 状态标签（不同颜色） | 订单状态、任务状态等 |
| 趋势值 | 趋势指示器（上升/下降箭头） | 同比增长、库存变化等 |
| 评分值 | 星级评分 | 产品评分、满意度等 |
| 进度值 | 进度条 | 完成率、使用率等 |
| 关键指标 | 突出显示（加粗、颜色） | KPI指标、超阈值数据等 |

## 6. 自定义映射规则

系统支持自定义映射规则，可通过以下方式扩展：

### 6.1 基于命名约定的映射

可以基于列名命名约定自动应用特定映射：

```json
{
  "columnNamePatterns": [
    {
      "pattern": ".*_status$",
      "uiComponent": "StatusBadge",
      "properties": {
        "options": [
          {"value": "active", "label": "活跃", "color": "green"},
          {"value": "inactive", "label": "不活跃", "color": "gray"},
          {"value": "pending", "label": "待处理", "color": "yellow"}
        ]
      }
    },
    {
      "pattern": "^is_.*",
      "uiComponent": "Switch",
      "properties": {
        "trueText": "是",
        "falseText": "否"
      }
    }
  ]
}
```

### 6.2 基于元数据的映射

可以基于表和列的元数据信息自动应用特定映射：

```json
{
  "tableColumnMappings": [
    {
      "table": "employees",
      "column": "department_id",
      "uiComponent": "DepartmentSelector",
      "properties": {
        "dataSource": "departments",
        "valueField": "id",
        "textField": "name"
      }
    },
    {
      "table": "products",
      "column": "category",
      "uiComponent": "CategoryTree",
      "properties": {
        "treeData": "product_categories",
        "multiple": false
      }
    }
  ]
}
```

## 7. 用户偏好学习

系统记录用户的显示偏好设置，用于智能推断默认配置：

1. **个人偏好记录**：记录每个用户对特定数据类型的组件选择和配置
2. **智能默认值**：为新建查询界面提供基于历史偏好的默认显示属性
3. **上下文感知**：根据查询场景（如查询条件数量、结果列特性）调整推荐

## 8. 映射框架实现

映射框架的核心实现包括：

1. **TypeMapperRegistry**：注册和管理所有类型映射器
2. **DatabaseTypeMapper**：数据库类型到Java类型的映射
3. **UIComponentMapper**：Java类型到UI组件的映射
4. **ValidationRuleGenerator**：根据数据类型和约束生成验证规则
5. **FormatterRegistry**：管理不同数据类型的格式化规则
6. **CustomMappingManager**：管理和应用自定义映射规则
7. **UserPreferenceManager**：记录和应用用户偏好设置

## 9. 扩展机制

映射框架提供以下扩展点：

1. **自定义类型映射器**：实现TypeMapper接口，支持新的数据类型
2. **自定义UI组件映射**：实现UIComponentMapper接口，支持新的UI组件
3. **自定义验证规则**：实现ValidationRuleGenerator接口，支持新的验证规则
4. **自定义格式化器**：实现Formatter接口，支持新的格式化规则
5. **插件机制**：通过SPI机制加载第三方映射插件

## 10. 最佳实践

1. **优先使用标准映射**：尽量使用系统提供的标准映射，保持一致性
2. **考虑数据规模**：大数据量场景选择性能更好的组件（如虚拟滚动表格）
3. **注重用户体验**：选择符合用户习惯的组件，减少学习成本
4. **保持简洁**：避免过度复杂的组件和配置，保持界面简洁
5. **响应式设计**：确保组件在不同设备上有良好表现
6. **考虑无障碍性**：选择支持键盘操作和屏幕阅读器的组件