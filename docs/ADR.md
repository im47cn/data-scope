# DataScope系统 - 架构决策记录 (ADR)

本文档记录了DataScope系统开发过程中所做的关键架构决策，包括决策的背景、考虑的替代方案、决策理由以及实施影响。

## ADR-001: 采用模块化单体架构

### 状态
已接受

### 日期
2025-03-18

### 上下文
需要为DataScope系统选择一个适合当前需求和未来扩展的架构模式。主要考虑了以下架构模式：
1. 扩展现有DDD六边形架构的单体应用
2. 微服务架构
3. 模块化单体架构

系统需要支持数据源管理、元数据提取、查询构建、NL2SQL转换、低代码集成等多种功能，且需要与现有架构保持兼容。

### 决策
采用**模块化单体架构**，在保持单体应用简单性的同时，通过明确的模块边界和接口增强系统的内聚性和可维护性。

### 替代方案
1. **简单扩展现有架构**：
   - 优点：改动最小，学习曲线低
   - 缺点：随着功能增加，可能导致代码混乱和耦合度增高

2. **微服务架构**：
   - 优点：高度模块化，服务独立扩展，技术栈灵活选择
   - 缺点：复杂的运维，服务间通信开销，与现有架构差异大

### 理由
1. 与现有系统架构兼容，迁移成本适中
2. 符合DDD的设计理念，保持领域模型的完整性
3. 模块化设计满足系统灵活性和可维护性需求
4. 为将来可能的微服务拆分做好准备
5. 适合当前项目规模和团队情况

### 影响
1. 需要定义清晰的模块边界和接口
2. 需要建立模块间的依赖管理机制
3. 开发团队需要遵循模块化设计原则
4. 测试策略需要支持模块级测试和集成测试

## ADR-002: Redis作为分布式缓存方案

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要高效处理元数据、查询结果、配置信息等数据，特别是在多用户环境下。需要选择一个适合的缓存方案提高系统性能。

### 决策
选择Redis作为系统的分布式缓存方案，并实施多层缓存策略。

### 替代方案
1. **内存缓存（如Caffeine）**：
   - 优点：简单，低延迟
   - 缺点：不支持分布式环境，内存占用较高

2. **EhCache**：
   - 优点：成熟，支持持久化
   - 缺点：分布式支持不如Redis强大

3. **Memcached**：
   - 优点：高性能，轻量级
   - 缺点：功能相对简单，数据结构支持有限

### 理由
1. Redis提供丰富的数据结构，适合存储不同类型的数据
2. 支持分布式环境，为将来的扩展做准备
3. 内置的过期策略和内存管理适合缓存场景
4. 提供发布/订阅机制，便于缓存同步
5. 持久化选项可保障缓存数据安全
6. 与Spring Cache无缝集成

### 影响
1. 系统需要增加Redis依赖
2. 需要管理Redis服务的部署和监控
3. 开发团队需要学习Redis的使用和最佳实践
4. 需要实施缓存失效策略以保证数据一致性

## ADR-003: 基于Git模型的SQL查询版本控制

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要支持SQL查询和API的版本管理，包括历史记录、差异比较、回滚等功能。需要设计一个适合的版本控制模型。

### 决策
采用类似Git的版本控制模型，记录查询和API的完整版本历史，支持差异比较和回滚操作。

### 替代方案
1. **简单的历史记录**：
   - 优点：实现简单
   - 缺点：不支持复杂的版本管理和差异比较

2. **基于时间点的快照**：
   - 优点：易于理解
   - 缺点：存储冗余，难以比较细粒度差异

3. **外部版本控制系统集成**：
   - 优点：利用成熟的版本控制系统
   - 缺点：增加系统复杂性，依赖外部系统

### 理由
1. Git模型是开发人员熟悉的版本控制模式，学习曲线低
2. 支持版本分支、合并和回滚等高级功能
3. 可以高效存储和比较SQL文本的差异
4. 便于实现协作编辑和冲突解决
5. 可扩展到其他需要版本控制的实体

### 影响
1. 需要设计和实现版本控制模型
2. 需要额外的数据库表存储版本历史
3. 用户界面需要支持版本管理操作
4. 系统备份需考虑版本历史数据

## ADR-004: 采用带盐的AES-256加密保护数据源凭证

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要安全存储数据库连接凭证，防止凭证泄露。需要选择一种安全可靠的加密方案。

### 决策
采用带唯一盐值的AES-256加密算法保护数据源凭证，密钥采用PBKDF2派生。

### 替代方案
1. **对称加密无盐**：
   - 优点：实现简单
   - 缺点：相同密码生成相同密文，易于彩虹表攻击

2. **不可逆哈希**：
   - 优点：安全性高
   - 缺点：不适用于需要解密获取原始凭证的场景

3. **非对称加密**：
   - 优点：公钥加密私钥解密更安全
   - 缺点：性能开销大，密钥管理复杂

### 理由
1. AES-256是业界认可的安全加密标准
2. 随机盐值确保即使相同密码也会生成不同密文
3. 支持解密操作，系统可在运行时使用凭证
4. 性能开销适中，适合频繁的加解密操作
5. 可以集成密钥轮换机制提高安全性

### 影响
1. 需要安全管理主加密密钥
2. 需要为每个凭证生成和存储唯一盐值
3. 加密过程需要CPU资源，可能影响性能
4. 需要实施密钥轮换和管理策略

## ADR-005: 基于置信度评分的表关系管理

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要管理数据库表之间的关系，包括显式定义的外键和推断的关系。需要一种方法来识别、存储和管理这些关系。

### 决策
采用带置信度评分的表关系管理模型，自动识别潜在关系并允许用户确认或调整。

### 替代方案
1. **仅支持显式外键**：
   - 优点：简单可靠
   - 缺点：无法处理未定义外键的数据库

2. **基于规则的固定关系推断**：
   - 优点：实现简单
   - 缺点：缺乏灵活性，不能适应不同的命名规范

3. **完全手动配置**：
   - 优点：最大灵活性
   - 缺点：用户负担重，效率低

### 理由
1. 自动识别减少用户工作量
2. 置信度评分帮助用户判断关系可靠性
3. 混合自动推断和手动确认的方法平衡效率和准确性
4. 可持续学习用户确认的模式提高推断准确性
5. 支持导出导入关系定义，便于环境迁移

### 影响
1. 需要实现关系推断算法
2. 需要存储和管理表关系数据
3. 用户界面需支持关系确认和编辑
4. 查询构建功能需利用表关系信息

## ADR-006: 基于开源LLM API的NL2SQL实现

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要支持自然语言到SQL的转换(NL2SQL)，使非技术用户可以通过自然语言描述获取数据。需要选择一种实现方案。

### 决策
采用开源LLM API(如OpenRouter)作为核心NL2SQL引擎，结合本地上下文处理和优化。

### 替代方案
1. **自建NL2SQL引擎**：
   - 优点：完全控制，无外部依赖
   - 缺点：开发成本高，难以达到大型LLM的效果

2. **商业NLP服务**：
   - 优点：成熟稳定，持续更新
   - 缺点：成本高，可能存在供应商锁定

3. **规则+模板混合方案**：
   - 优点：简单明确，结果可预测
   - 缺点：灵活性差，难以处理复杂查询意图

### 理由
1. LLM在NL2SQL任务上表现出色
2. 开源LLM降低依赖风险和使用成本
3. 本地上下文处理可优化与业务领域相关的查询
4. 随着模型演进可持续获得改进
5. 适合迭代开发，从简单场景开始逐步扩展

### 影响
1. 需要设计LLM提示工程方案
2. 需要收集和准备领域相关的训练数据
3. 用户界面需支持查询修正和反馈
4. 系统需处理LLM可能产生的错误SQL

## ADR-007: 前后端分离的UI架构

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要提供响应式、交互丰富的用户界面，并满足定制化和主题切换要求。需要选择合适的前端架构。

### 决策
采用前后端分离的UI架构，使用现代前端框架(Vue.js)，结合Tailwind CSS和第三方组件库。

### 替代方案
1. **服务器端渲染**：
   - 优点：初始加载快，SEO友好
   - 缺点：交互体验差，服务器负载高

2. **混合应用架构**：
   - 优点：结合两种方式的优点
   - 缺点：实现复杂，团队技能要求高

3. **原生移动应用**：
   - 优点：最佳用户体验，离线能力强
   - 缺点：开发成本高，多平台支持复杂

### 理由
1. 提供更加流畅和响应式的用户体验
2. 支持丰富的客户端交互和动态数据可视化
3. 清晰的关注点分离，便于前后端团队协作
4. 前端技术栈现代化，便于吸引和保留人才
5. 支持渐进式功能更新，减少用户干扰

### 影响
1. 需要设计和实现前后端接口
2. 需要单独部署和维护前端应用
3. 可能增加初始加载时间和前端复杂性
4. 需要实施前端构建和部署流程

## ADR-008: JSON协议标准化低代码平台集成

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要与低代码平台集成，实现查询结果和配置的双向同步。需要定义一种标准的集成方式。

### 决策
设计标准化的JSON协议作为低代码平台集成的基础，并提供Webhook机制实现实时更新。

### 替代方案
1. **自定义API集成**：
   - 优点：完全定制化
   - 缺点：每个平台需要单独适配

2. **SDK方式集成**：
   - 优点：功能丰富，使用简单
   - 缺点：需要为每种平台开发SDK

3. **直接数据库集成**：
   - 优点：实现简单
   - 缺点：耦合度高，安全性差

### 理由
1. JSON是通用的数据交换格式，几乎所有平台都支持
2. 协议定义使不同平台可以遵循相同标准集成
3. Webhook机制支持实时双向更新
4. 版本控制确保向后兼容性
5. 松耦合架构便于平台独立升级

### 影响
1. 需要设计和文档化JSON协议规范
2. 需要实现Webhook管理功能
3. 需要版本控制机制确保兼容性
4. 需要提供集成示例和文档

## ADR-009: 基于RBAC的权限控制模型

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要细粒度的访问控制，确保用户只能访问授权的数据源和执行授权的操作。需要选择一种权限控制模型。

### 决策
采用基于角色的访问控制(RBAC)模型，结合数据源级别和对象级别的权限控制。

### 替代方案
1. **简单的ACL(访问控制列表)**：
   - 优点：实现简单
   - 缺点：随着用户和资源增加，管理复杂度高

2. **基于属性的访问控制(ABAC)**：
   - 优点：高度灵活，可以基于多种属性控制
   - 缺点：实现复杂，性能影响较大

3. **特定应用的定制权限**：
   - 优点：完全适应特定需求
   - 缺点：难以扩展，无标准实现

### 理由
1. RBAC是成熟的权限控制模型，易于理解和实现
2. 通过角色简化权限管理，降低管理复杂度
3. 可以满足大多数企业权限场景需求
4. 易于与现有身份认证系统集成
5. 支持权限审计和合规性验证

### 影响
1. 需要设计角色和权限模型
2. 系统的所有功能需要集成权限检查
3. 用户界面需要根据权限动态调整
4. 需要提供权限管理功能
5. 查询执行需要考虑权限约束
