# 数据管理与查询系统 - 架构决策记录

本文档记录了数据管理与查询系统开发过程中的关键架构决策及其背后的理由。

## ADR-001: 采用前后端分离的模块化架构

### 状态
已接受

### 背景
系统需要支持复杂的数据源管理、查询构建、自然语言处理和低代码集成功能，同时需要考虑扩展性和可维护性。

### 决策
采用前后端分离的模块化架构，而非微服务架构或传统单体架构。

### 理由
1. **部署简便性**: 本地部署环境下，单一部署单元更易于管理
2. **模块化优势**: 通过清晰的模块边界和接口定义，保持系统的可维护性和可扩展性
3. **技术栈兼容性**: 与现有Java、SpringBoot、MyBatis技术栈高度兼容
4. **资源效率**: 避免微服务架构中的额外开销（服务发现、网络通信等）
5. **开发效率**: 减少跨服务调试的复杂性，加速开发过程

### 影响
- 模块间通过接口调用而非网络调用，减少了网络延迟但增加了内存共享风险
- 所有模块共享同一JVM资源，需要合理规划内存使用
- 未来扩展到分布式系统可能需要重构部分代码

### 相关决策
- ADR-002: 数据访问层设计
- ADR-005: 缓存策略设计

## ADR-002: 数据访问层设计

### 状态
已接受

### 背景
系统需要管理多个数据源的元数据，同时需要在这些数据源上执行查询。需要一个统一且高效的数据访问机制。

### 决策
采用Repository模式设计数据访问层，使用MyBatis作为ORM框架，并实现数据源适配器接口支持不同类型的数据库。

### 理由
1. **统一访问接口**: 通过Repository模式提供统一的数据访问接口
2. **ORM高效性**: MyBatis提供灵活的SQL映射和高效的性能
3. **适配器模式**: 允许系统无缝支持不同类型的数据库
4. **技术栈一致性**: 与现有技术栈保持一致

### 影响
- 需为每种数据库类型实现专用适配器
- 复杂查询可能需要特定数据库的优化
- 数据类型映射需要注意兼容性问题

### 相关决策
- ADR-007: 数据源凭证加密策略

## ADR-003: 采用基于Redis的缓存策略

### 状态
已接受

### 背景
系统需要高效处理查询请求和元数据访问，避免重复查询数据库造成性能瓶颈。

### 决策
实现多层缓存策略，主要使用Redis作为服务器端缓存，配合前端本地缓存和内存缓存。

### 理由
1. **性能优化**: Redis提供高性能的键值存储，显著减少数据库负载
2. **分布式支持**: 为未来可能的分布式部署提供共享缓存
3. **数据结构丰富**: Redis支持多种数据结构，适合缓存不同类型的数据
4. **过期策略**: 支持灵活的过期策略和缓存刷新机制
5. **内存管理**: 提供内存使用上限配置，防止缓存过度占用资源

### 影响
- 系统依赖Redis作为关键组件，需要确保Redis的可用性
- 缓存一致性需要精心设计，特别是元数据更新时
- 缓存策略需要针对不同类型的数据进行优化

### 相关决策
- ADR-002: 数据访问层设计
- ADR-008: 查询性能优化策略

## ADR-004: 整合OpenRouter LLM API用于自然语言查询

### 状态
已接受

### 背景
系统需要提供自然语言到SQL的转换功能，使非技术用户能够通过自然语言描述获取数据。

### 决策
集成OpenRouter LLM API处理自然语言查询，并开发专门的上下文增强和结果优化模块。

### 理由
1. **能力成熟度**: 大型语言模型在自然语言理解和转换方面表现出色
2. **开发效率**: 使用现有API而非自建NLP系统大幅降低开发复杂度
3. **持续改进**: LLM模型不断更新，系统可自动获得能力提升
4. **上下文增强**: 通过添加元数据上下文提高转换准确性
5. **学习能力**: 可从历史查询中学习，持续改进转换质量

### 影响
- 系统对外部API有依赖，需要考虑网络连接和服务可用性
- 可能存在额外的API调用成本
- 需要考虑查询安全性，确保生成的SQL不包含恶意操作

### 相关决策
- ADR-006: 查询构建与执行策略

## ADR-005: 采用JSON协议与低代码平台集成

### 状态
已接受

### 背景
系统需要与特定的低代码平台集成，提供数据查询和配置管理功能。

### 决策
设计基于JSON的交互协议，支持查询配置、表单生成和数据展示的定义与传输。

### 理由
1. **通用性**: JSON是广泛支持的数据交换格式，易于集成
2. **灵活性**: 协议可随需求演化而扩展
3. **人类可读**: 便于调试和文档化
4. **性能开销小**: 相比XML等格式，JSON解析更高效
5. **版本控制**: 支持协议版本控制，确保向后兼容性

### 影响
- 需要定义完整的协议规范和验证机制
- 协议变更需要考虑向后兼容性
- 需要确保JSON结构的安全性和有效性验证

### 相关决策
- ADR-009: API版本控制策略

## ADR-006: 查询构建与执行策略

### 状态
已接受

### 背景
系统需要支持用户构建复杂查询，并在不同类型的数据源上高效执行，同时确保安全性和性能。

### 决策
实现分层的查询处理架构，包括查询构建器、验证器、执行引擎和结果处理器，支持参数化查询和执行计划优化。

### 理由
1. **安全性**: 参数化查询防止SQL注入
2. **性能优化**: 执行计划分析和缓存提高查询效率
3. **跨数据库兼容**: 抽象查询接口支持不同数据库类型
4. **资源管理**: 查询超时和资源限制防止系统过载
5. **可审计性**: 完整的查询日志便于问题排查和性能分析

### 影响
- 复杂查询可能需要特定数据库的优化处理
- 查询翻译层需要处理不同SQL方言的差异
- 大结果集处理需要特殊考虑（分页、流处理）

### 相关决策
- ADR-003: 缓存策略
- ADR-008: 查询性能优化策略

## ADR-007: 数据源凭证加密策略

### 状态
已接受

### 背景
系统需要安全存储多个数据源的连接凭证，防止敏感信息泄露。

### 决策
采用AES-256加密算法，对每个密码使用单独加盐处理，并实现密钥轮换机制。

### 理由
1. **安全性**: AES-256是经过验证的强加密算法
2. **独立加盐**: 防止彩虹表攻击，即使部分凭证泄露也不影响其他凭证
3. **密钥管理**: 密钥不直接存储在配置文件中
4. **轮换机制**: 定期更新加密密钥提高安全性
5. **透明性**: 加密/解密过程对应用层透明

### 影响
- 密钥管理需要额外的安全机制
- 密钥轮换需要重新加密所有凭证
- 密钥丢失可能导致无法访问数据源

### 相关决策
- ADR-002: 数据访问层设计

## ADR-008: 查询性能优化策略

### 状态
已接受

### 背景
系统需要处理各种复杂度的查询，数据量从几千到几亿不等，需要确保响应时间和系统资源使用在合理范围内。

### 决策
实施多层次的查询性能优化策略，包括查询分析、执行计划优化、缓存、分页处理和资源限制。

### 理由
1. **查询分析**: 自动分析查询复杂度和潜在性能问题
2. **执行计划优化**: 根据数据库特性优化查询执行
3. **结果缓存**: 缓存常用查询结果减少重复执行
4. **分页处理**: 大数据集自动分页减少内存使用
5. **资源限制**: 查询超时机制和频率控制防止资源滥用

### 影响
- 优化策略可能因数据库类型而异
- 需要额外的监控和性能分析机制
- 缓存策略需要平衡命中率和内存使用

### 相关决策
- ADR-003: 缓存策略
- ADR-006: 查询构建与执行策略

## ADR-009: API版本控制策略

### 状态
已接受

### 背景
系统提供的API需要支持版本控制，确保在API变更时不影响现有调用方。

### 决策
在URL中包含版本号，支持多版本共存，并实施严格的向后兼容性策略。

### 理由
1. **显式版本**: URL中的版本号使API版本显而易见
2. **兼容性保证**: 一旦发布的API版本保证不会有破坏性变更
3. **平滑过渡**: 允许客户端逐步迁移到新版本
4. **隔离变更**: 不同版本的实现可以独立变更
5. **文档明确**: 每个版本有明确的文档和变更记录

### 影响
- 需要维护多版本的API实现
- 需要明确的版本废弃策略
- 文档需要标明每个版本的支持状态

### 相关决策
- ADR-005: JSON协议设计

## ADR-010: 采用基于HTML和Tailwind CSS的前端实现

### 状态
已接受

### 背景
系统需要提供美观、现代和响应式的用户界面，支持多种数据呈现形式和交互模式。

### 决策
前端采用HTML和Tailwind CSS构建，辅以Vue.js作为组件框架，FontAwesome提供图标。

### 理由
1. **开发效率**: Tailwind CSS提供丰富的预定义工具类，加速UI开发
2. **响应式设计**: 内置支持响应式布局，适应不同设备
3. **一致性**: 提供统一的设计语言和组件库
4. **性能**: 相比重框架，更轻量级，加载性能更好
5. **定制性**: 高度可定制，满足不同页面的设计需求

### 影响
- 需要建立一套UI组件库和设计规范
- 团队需要学习Tailwind CSS的工作方式
- 需要考虑CSS打包和优化

### 相关决策
- ADR-011: 数据可视化策略

## ADR-011: 数据可视化策略

### 状态
已接受

### 背景
系统需要支持多种数据呈现形式，包括表格、图表等，以直观展示查询结果。

### 决策
采用ECharts作为主要的数据可视化库，结合定制的表格组件和表单展示组件。

### 理由
1. **功能丰富**: ECharts支持广泛的图表类型和交互方式
2. **性能优化**: 针对大数据集进行了优化
3. **主题定制**: 支持灵活的主题定制，与整体UI风格一致
4. **交互性**: 提供丰富的交互功能，增强数据探索体验
5. **国际化支持**: 良好的中文支持和文档

### 影响
- 增加了前端包体积，需要考虑按需加载
- 复杂可视化可能需要专门的性能优化
- 需要设计一套统一的可视化配置规范

### 相关决策
- ADR-010: 前端实现策略

## ADR-012: 数据类型映射框架设计

### 状态
已接受

### 背景
系统需要在数据库数据类型和UI组件之间建立映射关系，自动化界面生成过程。

### 决策
实现可配置的数据类型映射框架，支持自定义映射规则和扩展。

### 理由
1. **自动化**: 减少手动配置，提高开发效率
2. **一致性**: 确保相同数据类型有一致的UI表现
3. **可扩展**: 支持添加新的数据类型和UI组件
4. **验证规则**: 包含数据验证规则，确保数据完整性
5. **默认合理**: 提供合理的默认映射，减少配置工作量

### 影响
- 需要维护完整的数据类型到UI组件的映射关系
- 特殊数据类型可能需要定制处理
- 映射规则需要考虑国际化和本地化

### 相关决策
- ADR-006: 查询构建与执行策略
- ADR-010: 前端实现策略