# DataScope系统 - 架构决策记录 (ADR)

本文档记录了DataScope系统开发过程中所做的关键架构决策，包括决策的背景、考虑的替代方案、决策理由以及实施影响。

## ADR-001: 采用模块化单体架构

### 状态
已接受

### 日期
2025-03-18

### 上下文
需要为DataScope系统选择一个适合当前需求和未来扩展的架构模式。主要考虑了以下架构模式：
1. 扩展现有DDD六边形架构的单体应用
2. 微服务架构
3. 模块化单体架构

系统需要支持数据源管理、元数据提取、查询构建、NL2SQL转换、低代码集成等多种功能，且需要与现有架构保持兼容。

### 决策
采用**模块化单体架构**，在保持单体应用简单性的同时，通过明确的模块边界和接口增强系统的内聚性和可维护性。

### 替代方案
1. **简单扩展现有架构**：
   - 优点：改动最小，学习曲线低
   - 缺点：随着功能增加，可能导致代码混乱和耦合度增高

2. **微服务架构**：
   - 优点：高度模块化，服务独立扩展，技术栈灵活选择
   - 缺点：复杂的运维，服务间通信开销，与现有架构差异大

### 理由
1. 与现有系统架构兼容，迁移成本适中
2. 符合DDD的设计理念，保持领域模型的完整性
3. 模块化设计满足系统灵活性和可维护性需求
4. 为将来可能的微服务拆分做好准备
5. 适合当前项目规模和团队情况

### 影响
1. 需要定义清晰的模块边界和接口
2. 需要建立模块间的依赖管理机制
3. 开发团队需要遵循模块化设计原则
4. 测试策略需要支持模块级测试和集成测试

## ADR-002: Redis作为分布式缓存方案

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要高效处理元数据、查询结果、配置信息等数据，特别是在多用户环境下。需要选择一个适合的缓存方案提高系统性能。

### 决策
选择Redis作为系统的分布式缓存方案，并实施多层缓存策略。

### 替代方案
1. **内存缓存（如Caffeine）**：
   - 优点：简单，低延迟
   - 缺点：不支持分布式环境，内存占用较高

2. **EhCache**：
   - 优点：成熟，支持持久化
   - 缺点：分布式支持不如Redis强大

3. **Memcached**：
   - 优点：高性能，轻量级
   - 缺点：功能相对简单，数据结构支持有限

### 理由
1. Redis提供丰富的数据结构，适合存储不同类型的数据
2. 支持分布式环境，为将来的扩展做准备
3. 内置的过期策略和内存管理适合缓存场景
4. 提供发布/订阅机制，便于缓存同步
5. 持久化选项可保障缓存数据安全
6. 与Spring Cache无缝集成

### 影响
1. 系统需要增加Redis依赖
2. 需要管理Redis服务的部署和监控
3. 开发团队需要学习Redis的使用和最佳实践
4. 需要实施缓存失效策略以保证数据一致性

## ADR-003: 基于Git模型的SQL查询版本控制

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要支持SQL查询和API的版本管理，包括历史记录、差异比较、回滚等功能。需要设计一个适合的版本控制模型。

### 决策
采用类似Git的版本控制模型，记录查询和API的完整版本历史，支持差异比较和回滚操作。

### 替代方案
1. **简单的历史记录**：
   - 优点：实现简单
   - 缺点：不支持复杂的版本管理和差异比较

2. **基于时间点的快照**：
   - 优点：易于理解
   - 缺点：存储冗余，难以比较细粒度差异

3. **外部版本控制系统集成**：
   - 优点：利用成熟的版本控制系统
   - 缺点：增加系统复杂性，依赖外部系统

### 理由
1. Git模型是开发人员熟悉的版本控制模式，学习曲线低
2. 支持版本分支、合并和回滚等高级功能
3. 可以高效存储和比较SQL文本的差异
4. 便于实现协作编辑和冲突解决
5. 可扩展到其他需要版本控制的实体

### 影响
1. 需要设计和实现版本控制模型
2. 需要额外的数据库表存储版本历史
3. 用户界面需要支持版本管理操作
4. 系统备份需考虑版本历史数据

## ADR-004: 采用带盐的AES-256加密保护数据源凭证

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要安全存储数据库连接凭证，防止凭证泄露。需要选择一种安全可靠的加密方案。

### 决策
采用带唯一盐值的AES-256加密算法保护数据源凭证，密钥采用PBKDF2派生。

### 替代方案
1. **对称加密无盐**：
   - 优点：实现简单
   - 缺点：相同密码生成相同密文，易于彩虹表攻击

2. **不可逆哈希**：
   - 优点：安全性高
   - 缺点：不适用于需要解密获取原始凭证的场景

3. **非对称加密**：
   - 优点：公钥加密私钥解密更安全
   - 缺点：性能开销大，密钥管理复杂

### 理由
1. AES-256是业界认可的安全加密标准
2. 随机盐值确保即使相同密码也会生成不同密文
3. 支持解密操作，系统可在运行时使用凭证
4. 性能开销适中，适合频繁的加解密操作
5. 可以集成密钥轮换机制提高安全性

### 影响
1. 需要安全管理主加密密钥
2. 需要为每个凭证生成和存储唯一盐值
3. 加密过程需要CPU资源，可能影响性能
4. 需要实施密钥轮换和管理策略

## ADR-005: 基于置信度评分的表关系管理

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要管理数据库表之间的关系，包括显式定义的外键和推断的关系。需要一种方法来识别、存储和管理这些关系。

### 决策
采用带置信度评分的表关系管理模型，自动识别潜在关系并允许用户确认或调整。

### 替代方案
1. **仅支持显式外键**：
   - 优点：简单可靠
   - 缺点：无法处理未定义外键的数据库

2. **基于规则的固定关系推断**：
   - 优点：实现简单
   - 缺点：缺乏灵活性，不能适应不同的命名规范

3. **完全手动配置**：
   - 优点：最大灵活性
   - 缺点：用户负担重，效率低

### 理由
1. 自动识别减少用户工作量
2. 置信度评分帮助用户判断关系可靠性
3. 混合自动推断和手动确认的方法平衡效率和准确性
4. 可持续学习用户确认的模式提高推断准确性
5. 支持导出导入关系定义，便于环境迁移

### 影响
1. 需要实现关系推断算法
2. 需要存储和管理表关系数据
3. 用户界面需支持关系确认和编辑
4. 查询构建功能需利用表关系信息

## ADR-006: 基于OpenRouter LLM API的NL2SQL实现

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要支持自然语言到SQL的转换(NL2SQL)，使非技术用户可以通过自然语言描述获取数据。需要选择一种实现方案。

### 决策
采用OpenRouter LLM API作为核心NL2SQL引擎，结合本地上下文处理和优化。

### 替代方案
1. **自建NL2SQL引擎**：
   - 优点：完全控制，无外部依赖
   - 缺点：开发复杂，需要专业NLP知识

2. **基于规则的简单转换**：
   - 优点：轻量级，可控
   - 缺点：功能受限，难以处理复杂查询

3. **开源NL2SQL框架**：
   - 优点：社区支持，免费
   - 缺点：性能和准确性可能不如商业解决方案

### 理由
1. 大型语言模型在自然语言理解方面表现优秀
2. OpenRouter提供了多种LLM选择，可根据性能和成本平衡
3. 系统可以提供上下文信息（元数据、表关系）增强转换准确性
4. 可以通过反馈循环不断提高转换质量
5. API方式部署简单，可根据需求扩展

### 影响
1. 系统需要管理API密钥和计费
2. 需要处理API请求限制和故障
3. 需要设计提示工程(prompt engineering)最大化性能
4. 需要本地处理逻辑优化API使用

## ADR-007: JSON协议标准化低代码平台集成

### 状态
已接受

### 日期
2025-03-18

### 上下文
DataScope系统需要与低代码平台集成，实现查询结果和配置的双向同步。需要定义一种标准的集成方式。

### 决策
设计标准化的JSON协议作为低代码平台集成的基础，并提供Webhook机制实现实时更新。

### 替代方案
1. **自定义API集成**：
   - 优点：完全定制化
   - 缺点：每个平台需要单独适配

2. **SDK方式集成**：
   - 优点：功能丰富，使用简单
   - 缺点：需要为每种平台开发SDK

3. **直接数据库集成**：
   - 优点：实现简单
   - 缺点：耦合度高，安全性差

### 理由
1. JSON是通用的数据交换格式，几乎所有平台都支持
2. 协议定义使不同平台可以遵循相同标准集成
3. Webhook机制支持实时双向更新
4. 版本控制确保向后兼容性
5. 松耦合架构便于平台独立升级

### 影响
1. 需要设计和文档化JSON协议规范
2. 需要实现Webhook管理功能
3. 需要版本控制机制确保兼容性
4. 需要提供集成示例和文档